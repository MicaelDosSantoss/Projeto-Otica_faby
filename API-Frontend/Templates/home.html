<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='home/logo.png') }}" type="image/x-icon">
    <title>Loja de Ã“culos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home_style.css') }}">
</head>

<body>
    <!-- TOPO -->
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='home/logo.png') }}" alt="Logo da loja" style="height: 90px;">
        </div>
        <div class="user-icon" id="userIconContainer">
            <img src="{{ url_for('static', filename='home/icon.png') }}" alt="Ãcone do usuÃ¡rio" style="height: 50px; cursor: pointer;" id="userIcon">

            <div class="user-dropdown" id="userDropdown">
                <div class="user-info">
                    <p class="user-name">{{ current_user.Nome }}</p>
                    <p class="user-email">{{ current_user.Email }}</p>
                </div>
                <hr>
                <a href="{{ url_for('venda.ver_carrinho') }}" class="dropdown-item">
                    <span>ðŸ›’</span> Meu Carrinho
                </a>
                <a href="{{ url_for('auth.logout') }}" class="dropdown-item logout">
                    <span>ðŸšª</span> Sair
                </a>
            </div>
        </div>
    </header>

    <!-- CONTEÃšDO -->
    <main class="container">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
            <button class="close-alert" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <section class="products">

            {% if oculos %}
            {% for o in oculos %}

            <div class="card">

                <div class="product-image">
                    <a href="item/{{ o['Id_Oculos'] }}" style="text-decoration: none; color: inherit;">
                        {% if o['Imagem'] %}
                        <img src="{{ url_for('static', filename='uploads/' + o['Imagem']) }}"
                             alt="Ã“culos {{ o['Modelo'] }}"
                             style="padding-top: 10px; padding-bottom: 10px;">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/default.png') }}"
                             alt="Ã“culos sem imagem"
                             style="padding-top: 10px; padding-bottom: 10px;"
                             width="275" height="183">
                        {% endif %}
                    </a>
                </div>

                <div class="product-info">

                    <img src="{{ url_for('static', filename='marcas/marcas_itens/' + o['Nome_Marca'] + '.png') }}"
                         alt="Marca {{ o['Nome_Marca'] }}" class="brand-logo">

                    <p class="model">{{ o['Modelo'] }}</p>

                    <div class="esp">
                        <p class="price">R$ {{ "%.2f" | format(o['Valor'] | float) }}</p>
                        <p class="stock">Restam {{ o['Quantidade'] }} uni.</p>
                    </div>

                    <p class="payment">
                        Ã€ vista no PIX<br>
                        Ou atÃ© 10x de R$ {{ "%.2f" | format(o['Valor'] | float / 10) }}
                    </p>

                    <!-- BotÃ£o Comprar fora do <a> -->
                    <button class="buy-btn" onclick="adicionarAoCarrinho('{{ o['Id_Oculos'] }}')">
                        ADICIONAR AO CARRINHO
                    </button>

                </div>
            </div>

            {% endfor %}
            {% else %}
            <p class="text-light">Nenhum Ã³culos disponÃ­vel no momento.</p>
            {% endif %}

        </section>

    </main>

    <script>
        // Usado para abrir e fechar o menu do usuÃ¡rio
        const userIcon = document.getElementById('userIcon');
        const userDropdown = document.getElementById('userDropdown');

        userIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('userIconContainer').contains(e.target)) {
                userDropdown.classList.remove('show');
            }
        });

        // FunÃ§Ã£o AJAX para adicionar ao carrinho
        function adicionarAoCarrinho(oculosId) {
            fetch('{{ url_for("venda.adicionar_ao_carrinho") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ oculos_id: oculosId, quantidade: 1 }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.erro) {
                        alert('Erro ao adicionar ao carrinho: ' + data.erro);
                    } else {
                        alert('Item adicionado ao carrinho!');
                    }
                })
                .catch((error) => {
                    console.error('Erro:', error);
                    alert('Erro ao adicionar ao carrinho.');
                });
        }
    </script>

</body>

</html>
