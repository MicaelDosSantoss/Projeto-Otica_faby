<!DOCTYPE html>
<html>
<head>
    <title>Lista de Óculos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/oculos.css') }}">

    <script>
        function toggleForm() {
            const formDiv = document.getElementById('formOculos');
            formDiv.style.display = formDiv.style.display === 'none' ? 'block' : 'none';
        }

        function deletarOculos(id) {
            fetch('/oculos/delete/' + id, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erro ao deletar o óculos, item em questão relacionando no carrinho.');
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    alert('Erro ao tentar deletar o óculos.');
                });
        }

        // Função de preenchimento atualizada para os novos campos
        function preencherFormularioEdicao(id, modelo, material_fk, forma_fk, marca_fk, valor, quantidade, descricao, sobre_produto) {
            document.getElementById('editID').value = id;
            document.getElementById('editModelo').value = modelo;
            document.getElementById('editMaterial_FK').value = material_fk;
            document.getElementById('editForma_FK').value = forma_fk;
            document.getElementById('editMarca_FK').value = marca_fk;
            document.getElementById('editValor').value = valor;
            document.getElementById('editQuantidade').value = quantidade;
            document.getElementById('editDescricao').value = descricao;
            document.getElementById('editSobre_Produto').value = sobre_produto;
            
            // Campos antigos removidos: Cor, Tamanho, Genero, Data_Recebimento
            
            document.getElementById('formOculosEdit').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function atualizarOculos() {
            const id = document.getElementById('editID').value;
            const formData = new FormData();
            
            // Novos campos
            formData.append('Modelo', document.getElementById('editModelo').value);
            formData.append('Material_FK', document.getElementById('editMaterial_FK').value);
            formData.append('Forma_FK', document.getElementById('editForma_FK').value);
            formData.append('Marca_FK', document.getElementById('editMarca_FK').value);
            formData.append('Valor', document.getElementById('editValor').value);
            formData.append('Quantidade', document.getElementById('editQuantidade').value);
            formData.append('Descricao', document.getElementById('editDescricao').value);
            formData.append('Sobre_Produto', document.getElementById('editSobre_Produto').value);
            
            // Campos antigos removidos: Cor, Tamanho, Genero, Data_Recebimento
            
            // Imagem (mantida para compatibilidade, mas não usada no DB)
            const imagem = document.getElementById('editImagem').files[0];
            if (imagem) {
                formData.append('Imagem', imagem);
            }

            fetch('/oculos/update/' + id, {
                method: 'PUT',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert('Óculos atualizado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao atualizar o óculos.');
                }
            })
            .catch(error => {
                console.error('Erro ao enviar atualização:', error);
                alert('Erro ao enviar a atualização.');
            });
        }
    </script>
</head>
<body>
<div class="container table-wrapper">
    <h1 class="text-center">Óculos</h1>

    {% if error %}
        <div class="alert alert-warning text-center">{{ error }}</div>
    {% endif %}

    <!-- Botão para mostrar o formulário de criação -->
    <div class="text-center mb-3">
        <button class="btn btn-success" onclick="toggleForm()">+ Novo Óculos</button>
    </div>

    <!-- Formulário de criação (POST) -->
    <div id="formOculos" style="display: none;" class="mb-4">
        <form action="/oculos" method="POST" enctype="multipart/form-data" class="form-inline justify-content-center flex-wrap">
            
            <!-- Modelo (Novo campo, substitui Nome) -->
            <input type="text" name="Modelo" class="form-control mx-1 mb-2" placeholder="Modelo" required>

            <!-- Forma_FK -->
            <select name="Forma_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Forma</option>
                {% for forma in formas %}
                    <option value="{{ forma['Id_Forma'] }}">{{ forma['Nome'] }}</option>
                {% endfor %}
            </select>
            
            <!-- Material_FK -->
            <select name="Material_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione o Material</option>
                {% for material in materiais %}
                    <option value="{{ material['Id_Material'] }}">{{ material['Nome'] }}</option>
                {% endfor %}
            </select>

            <!-- Marca_FK -->
            <select name="Marca_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca['Id_Marca'] }}">{{ marca['Nome'] }}</option>
                {% endfor %}
            </select>
            
            <!-- Valor -->
            <input type="number" step="0.01" name="Valor" class="form-control mx-1 mb-2" placeholder="Valor" required>
            
            <!-- Quantidade (Novo campo) -->
            <input type="number" name="Quantidade" class="form-control mx-1 mb-2" placeholder="Quantidade" required>
            
            <!-- Descricao (Novo campo) -->
            <textarea name="Descricao" class="form-control mx-1 mb-2" placeholder="Descrição"></textarea>
            
            <!-- Sobre_Produto (Novo campo) -->
            <textarea name="Sobre_Produto" class="form-control mx-1 mb-2" placeholder="Sobre o Produto"></textarea>
            
            <!-- Imagem (Mantido para compatibilidade) -->
            <input type="file" name="Imagem" accept="image/*" class="form-control-file mx-1 mb-2">
            
            <button type="submit" class="btn btn-primary mb-2">Salvar</button>
        </form>
    </div>

    <!-- Formulário de edição (PUT) -->
    <div id="formOculosEdit" style="display: none;" class="mb-4">
        <form onsubmit="event.preventDefault(); atualizarOculos();" class="form-inline justify-content-center flex-wrap">
            <input type="hidden" id="editID">
            
            <!-- Modelo -->
            <input type="text" id="editModelo" class="form-control mx-1 mb-2" placeholder="Modelo" required>

            <!-- Forma_FK -->
            <select id="editForma_FK" name="Forma_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Forma</option>
                {% for forma in formas %}
                    <option value="{{ forma['Id_Forma'] }}">{{ forma['Nome'] }}</option>
                {% endfor %}
            </select>
            
            <!-- Material_FK -->
            <select id="editMaterial_FK" name="Material_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione o Material</option>
                {% for material in materiais %}
                    <option value="{{ material['Id_Material'] }}">{{ material['Nome'] }}</option>
                {% endfor %}
            </select>

            <!-- Marca_FK -->
            <select id="editMarca_FK" name="Marca_FK" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca['Id_Marca'] }}">{{ marca['Nome'] }}</option>
                {% endfor %}
            </select>
            
            <!-- Valor -->
            <input type="number" step="0.01" id="editValor" class="form-control mx-1 mb-2" placeholder="Valor" required>
            
            <!-- Quantidade -->
            <input type="number" id="editQuantidade" class="form-control mx-1 mb-2" placeholder="Quantidade" required>
            
            <!-- Descricao -->
            <textarea id="editDescricao" name="Descricao" class="form-control mx-1 mb-2" placeholder="Descrição"></textarea>
            
            <!-- Sobre_Produto -->
            <textarea id="editSobre_Produto" name="Sobre_Produto" class="form-control mx-1 mb-2" placeholder="Sobre o Produto"></textarea>
            
            <!-- Imagem -->
            <input type="file" id="editImagem" accept="image/*" class="form-control-file mx-1 mb-2">
            
            <button type="submit" class="btn btn-warning mb-2">Atualizar</button>
        </form>
    </div>

    <!-- Tabela -->
    {% if oculos %}
        <table class="table table-striped table-bordered text-center align-middle">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Modelo</th>
                    <th>    Forma</th>
                    <th>Material</th>
                    <th>Marca</th>
                    <th>Valor</th>
                    <th>Quantidade</th>
                    <th>Descrição</th>
                    <th>Sobre o Produto</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for o in oculos %}
                <tr>
                    <td>{{ o['Id_Oculos'] }}</td>
                    <td>{{ o['Modelo'] }}</td>
                    <td>{{ o['Nome_Forma'] }}</td>
                    <td>{{ o['Nome_Material'] }}</td>
                    <td>{{ o['Nome_Marca'] }}</td>
                    <td>R$ {{ o['Valor'] }}</td>
                    <td>{{ o['Quantidade'] }}</td>
                    <td>{{ o['Descricao'] | default('N/A', true) }}</td>
                    <td>{{ o['Sobre_Produto'] | default('N/A', true) }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="preencherFormularioEdicao(
                            '{{ o['Id_Oculos'] }}',
                            '{{ o['Modelo'] }}',
                            '{{ o['Material_FK'] }}',
                            '{{ o['Forma_FK'] }}',
                            '{{ o['Marca_FK'] }}',
                            '{{ o['Valor'] }}',
                            '{{ o['Quantidade'] }}',
                            '{{ o['Descricao'] | default('', true) }}',
                            '{{ o['Sobre_Produto'] | default('', true) }}'
                        )">Atualizar</button>
                        <button class="btn btn-sm btn-danger" onclick="deletarOculos('{{ o['Id_Oculos'] }}')">Deletar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center">Nenhum óculos disponível.</p>
    {% endif %}
</div>
</body>
</html>
